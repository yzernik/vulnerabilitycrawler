commit cf1ec146f7c6acdc6697032b3aaafc68ffacdcac
Author: Rodrigo Kumpera <kumpera@gmail.com>
Date:   Thu Nov 25 14:23:31 2010 -0200

    Handle invalid instantiation of generic methods.
    
    	* verify.c: Add new function to internal verifier API to check
    	method instantiations.
    
    	* reflection.c (mono_reflection_bind_generic_method_parameters):
    	Check the instantiation before returning it.
    
    	Fixes #655847

diff --git a/mono/metadata/reflection.c b/mono/metadata/reflection.c
index d43ad08..15e6496 100644
--- a/mono/metadata/reflection.c
+++ b/mono/metadata/reflection.c
@@ -10605,6 +10605,9 @@ mono_reflection_bind_generic_method_parameters (MonoReflectionMethod *rmethod, M
 		mono_g_hash_table_insert (image->generic_def_objects, imethod, rmethod);
 		mono_loader_unlock ();
 	}
+
+	if (!mono_verifier_is_method_valid_generic_instantiation (inflated))
+		mono_raise_exception (mono_get_exception_argument ("typeArguments", "Invalid generic arguments"));
 	
 	return mono_method_get_object (mono_object_domain (rmethod), inflated, NULL);
 }
diff --git a/mono/metadata/verify-internals.h b/mono/metadata/verify-internals.h
index 1d0fb75..e01325e 100644
--- a/mono/metadata/verify-internals.h
+++ b/mono/metadata/verify-internals.h
@@ -22,6 +22,7 @@ gboolean mono_verifier_is_enabled_for_class (MonoClass *klass) MONO_INTERNAL;
 gboolean mono_verifier_is_method_full_trust (MonoMethod *method) MONO_INTERNAL;
 gboolean mono_verifier_is_class_full_trust (MonoClass *klass) MONO_INTERNAL;
 gboolean mono_verifier_class_is_valid_generic_instantiation (MonoClass *class) MONO_INTERNAL;
+gboolean mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method) MONO_INTERNAL;
 
 gboolean mono_verifier_verify_class (MonoClass *klass) MONO_INTERNAL;
 
diff --git a/mono/metadata/verify.c b/mono/metadata/verify.c
index a1d5bcf..81eb1ef 100644
--- a/mono/metadata/verify.c
+++ b/mono/metadata/verify.c
@@ -6042,6 +6042,14 @@ mono_verifier_class_is_valid_generic_instantiation (MonoClass *class)
 	return mono_class_is_valid_generic_instantiation (NULL, class);
 }
 
+gboolean
+mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)
+{
+	if (!method->is_inflated)
+		return TRUE;
+	return mono_method_is_valid_generic_instantiation (NULL, method);
+}
+
 #else
 
 gboolean
@@ -6113,5 +6121,12 @@ mono_verifier_class_is_valid_generic_instantiation (MonoClass *class)
 	return TRUE;
 }
 
+gboolean
+mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)
+{
+	return TRUE;
+}
+
+
 
 #endif
